
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOD Processing System Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: #333; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .status { padding: 5px 10px; border-radius: 4px; color: white; font-weight: bold; }
        .status.ok { background: #28a745; }
        .status.error { background: #dc3545; }
        .status.warning { background: #ffc107; color: #333; }
        .metric { font-size: 24px; font-weight: bold; margin: 10px 0; }
        .refresh-btn { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
        .refresh-btn:hover { background: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸš€ VOD Processing System Monitor</h1>
            <p>Real-time system status and performance metrics</p>
            <button class="refresh-btn" onclick="refreshData()">ðŸ”„ Refresh</button>
        </div>
        
        <div class="grid">
            <div class="card">
                <h3>ðŸ’» System Resources</h3>
                <div id="system-stats">Loading...</div>
            </div>
            
            <div class="card">
                <h3>ðŸ”´ Redis Status</h3>
                <div id="redis-status">Loading...</div>
            </div>
            
            <div class="card">
                <h3>âš¡ Celery Workers</h3>
                <div id="celery-status">Loading...</div>
            </div>
            
            <div class="card">
                <h3>ðŸ“¡ Cablecast API</h3>
                <div id="cablecast-status">Loading...</div>
            </div>
            
            <div class="card">
                <h3>ðŸ’¾ Flex Mounts</h3>
                <div id="mounts-status">Loading...</div>
            </div>
            
            <div class="card">
                <h3>ðŸ“‹ Recent Tasks</h3>
                <div id="tasks-list">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        function refreshData() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    updateSystemStats(data.system);
                    updateRedisStatus(data.redis);
                    updateCeleryStatus(data.celery);
                    updateCablecastStatus(data.cablecast);
                    updateMountsStatus(data.flex_mounts);
                    updateTasksList(data.recent_tasks);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    document.body.innerHTML += '<div style="color: red; padding: 20px;">Error loading data</div>';
                });
        }

        function updateSystemStats(stats) {
            const div = document.getElementById('system-stats');
            if (stats.error) {
                div.innerHTML = `<span class="status error">Error: ${stats.error}</span>`;
                return;
            }
            
            div.innerHTML = `
                <div class="metric">${stats.cpu_percent}%</div>
                <div>CPU Usage</div>
                <div class="metric">${stats.memory_percent}%</div>
                <div>Memory Usage (${stats.memory_used_gb.toFixed(1)}GB / ${stats.memory_total_gb.toFixed(1)}GB)</div>
                <div class="metric">${stats.disk_percent}%</div>
                <div>Disk Usage (${stats.disk_used_gb.toFixed(1)}GB / ${stats.disk_total_gb.toFixed(1)}GB)</div>
            `;
        }

        function updateRedisStatus(status) {
            const div = document.getElementById('redis-status');
            if (status.status === 'connected') {
                div.innerHTML = `
                    <span class="status ok">Connected</span>
                    <div>Version: ${status.version}</div>
                    <div>Clients: ${status.connected_clients}</div>
                    <div>Memory: ${status.used_memory_mb}</div>
                    <div>Uptime: ${Math.floor(status.uptime_seconds / 3600)}h</div>
                `;
            } else {
                div.innerHTML = `<span class="status error">Disconnected</span>`;
            }
        }

        function updateCeleryStatus(status) {
            const div = document.getElementById('celery-status');
            if (status.error) {
                div.innerHTML = `<span class="status error">Error: ${status.error}</span>`;
                return;
            }
            
            const taskStats = Object.entries(status.task_stats || {})
                .map(([status, count]) => `${status}: ${count}`)
                .join('<br>');
            
            div.innerHTML = `
                <div class="metric">${status.active_workers}</div>
                <div>Active Workers</div>
                <div class="metric">${status.total_tasks}</div>
                <div>Total Tasks</div>
                <div><strong>Task Status:</strong></div>
                <div>${taskStats}</div>
            `;
        }

        function updateCablecastStatus(status) {
            const div = document.getElementById('cablecast-status');
            if (status.status === 'connected') {
                div.innerHTML = `<span class="status ok">Connected</span>`;
            } else {
                div.innerHTML = `<span class="status error">Disconnected</span>`;
            }
        }

        function updateMountsStatus(mounts) {
            const div = document.getElementById('mounts-status');
            let html = '';
            
            Object.entries(mounts).forEach(([name, mount]) => {
                const statusClass = mount.mounted && mount.write_access ? 'ok' : 
                                  mount.mounted ? 'warning' : 'error';
                const statusText = mount.mounted && mount.write_access ? 'OK' :
                                 mount.mounted ? 'Read Only' : 'Not Mounted';
                
                html += `
                    <div style="margin: 5px 0;">
                        <strong>${name}:</strong> 
                        <span class="status ${statusClass}">${statusText}</span>
                    </div>
                `;
            });
            
            div.innerHTML = html;
        }

        function updateTasksList(tasks) {
            const div = document.getElementById('tasks-list');
            if (tasks.error) {
                div.innerHTML = `<span class="status error">Error: ${tasks.error}</span>`;
                return;
            }
            
            if (tasks.length === 0) {
                div.innerHTML = '<div>No recent tasks</div>';
                return;
            }
            
            let html = '';
            tasks.slice(0, 5).forEach(task => {
                const statusClass = task.status === 'SUCCESS' ? 'ok' : 
                                  task.status === 'FAILURE' ? 'error' : 'warning';
                html += `
                    <div style="margin: 5px 0; padding: 5px; border-bottom: 1px solid #eee;">
                        <div><strong>${task.name}</strong></div>
                        <div>ID: ${task.id}</div>
                        <div>Status: <span class="status ${statusClass}">${task.status}</span></div>
                    </div>
                `;
            });
            
            div.innerHTML = html;
        }

        // Initial load
        refreshData();
        
        // Auto-refresh every 30 seconds
        setInterval(refreshData, 30000);
    </script>
</body>
</html>
            