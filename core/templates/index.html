<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archivist - Video Transcription</title>
    <!-- Use local Tailwind CSS -->
    <link href="{{ url_for('static', filename='css/tailwind.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/main.css') }}" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold mb-2">Archivist</h1>
            <p class="text-gray-400">Video Transcription System</p>
        </header>

        <!-- Search Bar -->
        <div class="mb-6">
            <div class="flex gap-4">
                <input type="text" id="search-input" placeholder="Search files or transcriptions..." 
                       class="flex-1 bg-gray-700 text-white px-4 py-2 rounded">
                <select id="search-type" class="bg-gray-700 text-white px-4 py-2 rounded">
                    <option value="files">Files</option>
                    <option value="transcriptions">Transcriptions</option>
                </select>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
            <!-- File Browser -->
            <div class="bg-gray-800 rounded-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">File Browser</h2>
                    <div class="flex gap-2">
                        <button onclick="refreshFiles()" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded">
                            Refresh
                        </button>
                        <button onclick="showFileDetails()" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded">
                            Details
                        </button>
                    </div>
                </div>
                <div class="mb-4">
                    <div class="flex gap-2">
                        <input type="text" id="current-path" class="flex-1 bg-gray-700 text-white px-4 py-2 rounded" readonly>
                        <button onclick="navigateUp()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                            Up
                        </button>
                    </div>
                </div>
                <div id="file-list" class="space-y-2 max-h-96 overflow-y-auto">
                    <!-- Files will be listed here -->
                </div>
                <div class="mt-4">
                    <button id="queue-selected-btn" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded" onclick="queueSelectedFiles()">
                        Queue Selected for Transcription
                    </button>
                </div>
            </div>

            <!-- Queue Status -->
            <div class="bg-gray-800 rounded-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Transcription Queue</h2>
                    <button onclick="updateQueue()" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded">
                        Refresh
                    </button>
                </div>
                <div id="queue-list" class="space-y-4 max-h-96 overflow-y-auto">
                    <!-- Queue items will be listed here -->
                </div>
            </div>
        </div>

        <!-- Completed Transcriptions -->
        <div class="bg-gray-800 rounded-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Completed Transcriptions</h2>
                <div class="flex gap-2">
                    <input type="text" id="transcription-search" placeholder="Search transcriptions..." 
                           class="bg-gray-700 text-white px-4 py-2 rounded">
                    <button onclick="loadCompletedTranscriptions()" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded">
                        Refresh
                    </button>
                </div>
            </div>
            <div id="completed-list" class="space-y-4 max-h-96 overflow-y-auto">
                <!-- Completed transcriptions will be listed here -->
            </div>
        </div>
    </div>

    <!-- File Details Modal -->
    <div id="file-details-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-gray-800 rounded-lg p-6 max-w-2xl w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">File Details</h3>
                <button onclick="closeFileDetails()" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div id="file-details-content" class="space-y-4">
                <!-- File details will be shown here -->
            </div>
        </div>
    </div>

    <script>
        let currentPath = '';
        let queueUpdateInterval;
        let selectedFiles = new Set(); // Track multiple selected files

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadFiles();
            updateQueue();
            loadCompletedTranscriptions();
            queueUpdateInterval = setInterval(updateQueue, 5000);
        });

        // Search functionality
        document.getElementById('search-input').addEventListener('input', function(e) {
            const searchType = document.getElementById('search-type').value;
            if (searchType === 'files') {
                searchFiles(e.target.value);
            } else {
                searchTranscriptions(e.target.value);
            }
        });

        // Search functions
        function searchFiles(query) {
            const fileList = document.getElementById('file-list');
            const items = fileList.getElementsByClassName('file-item');
            Array.from(items).forEach(item => {
                const name = item.querySelector('.file-name').textContent.toLowerCase();
                if (name.includes(query.toLowerCase())) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function searchTranscriptions(query) {
            const completedList = document.getElementById('completed-list');
            const items = completedList.getElementsByClassName('transcription-item');
            Array.from(items).forEach(item => {
                const name = item.querySelector('h3').textContent.toLowerCase();
                if (name.includes(query.toLowerCase())) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Load files for current directory
        function loadFiles() {
            const path = currentPath || '';
            const fileList = document.getElementById('file-list');
            
            // Show loading state
            fileList.innerHTML = '<div class="text-gray-400 p-4 text-center">Loading...</div>';
            
            fetch(`/api/browse?path=${encodeURIComponent(path)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(items => {
                    if (!Array.isArray(items)) {
                        throw new Error('Invalid response format');
                    }
                    
                    document.getElementById('current-path').value = path;
                    selectedFiles.clear(); // Clear selection when loading new directory
                    
                    if (items.length === 0) {
                        fileList.innerHTML = '<div class="text-gray-400 p-4 text-center">No files found</div>';
                        return;
                    }
                    
                    fileList.innerHTML = items.map(item => {
                        if (item.type === 'directory') {
                            return `
                                <div class="file-item flex items-center justify-between p-2 hover:bg-gray-700 rounded cursor-pointer" onclick="navigate('${item.path}')">
                                    <div class="flex items-center gap-2">
                                        <span class="text-gray-400">üìÅ</span>
                                        <span class="file-name">${item.name}</span>
                                    </div>
                                    <span class="text-sm text-gray-400">Directory</span>
                                </div>
                            `;
                        } else {
                            return `
                                <div class="file-item flex items-center justify-between p-2 hover:bg-gray-700 rounded">
                                    <div class="flex items-center gap-2">
                                        <input type="checkbox" class="file-checkbox" value="${item.path}" 
                                               onchange="handleFileSelection('${item.path}', this.checked)">
                                        <span class="text-gray-400">üìÑ</span>
                                        <span class="file-name">${item.name}</span>
                                    </div>
                                    <span class="text-sm text-gray-400">${formatSize(item.size)}</span>
                                </div>
                            `;
                        }
                    }).join('');
                })
                .catch(error => {
                    console.error('Error loading files:', error);
                    showNotification('Error loading files: ' + error.message, 'error');
                    fileList.innerHTML = '<div class="text-red-400 p-4 text-center">Error loading files</div>';
                });
        }

        // Handle file selection
        function handleFileSelection(path, isSelected) {
            if (isSelected) {
                selectedFiles.add(path);
            } else {
                selectedFiles.delete(path);
            }
            
            // Update queue button state
            const queueBtn = document.getElementById('queue-selected-btn');
            if (selectedFiles.size > 0) {
                queueBtn.textContent = `Queue ${selectedFiles.size} Selected File(s)`;
                queueBtn.classList.remove('bg-gray-600');
                queueBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            } else {
                queueBtn.textContent = 'Queue Selected for Transcription';
                queueBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                queueBtn.classList.add('bg-gray-600');
            }
        }

        // Load completed transcriptions
        function loadCompletedTranscriptions() {
            fetch('/api/transcriptions')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    if (!Array.isArray(data)) {
                        throw new Error('Invalid response format');
                    }
                    
                    const completedList = document.getElementById('completed-list');
                    if (data.length === 0) {
                        completedList.innerHTML = '<div class="text-gray-400 p-4 text-center">No completed transcriptions</div>';
                        return;
                    }
                    
                    completedList.innerHTML = data.map(trans => `
                        <div class="transcription-item bg-gray-700 rounded p-4">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-semibold">${trans.video_path.split('/').pop()}</h3>
                                    <p class="text-sm text-gray-400">Completed: ${new Date(trans.completed_at).toLocaleString()}</p>
                                    <p class="text-sm text-gray-400">Status: ${trans.status}</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="viewTranscription('${trans.id}')" 
                                            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                                        View
                                    </button>
                                    <button onclick="downloadTranscription('${trans.id}')"
                                            class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                                        Download
                                    </button>
                                    ${trans.status === 'failed' ? `
                                        <button onclick="removeTranscription('${trans.id}')"
                                                class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                                            Remove
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('');
                })
                .catch(error => {
                    console.error('Error loading transcriptions:', error);
                    showNotification('Error loading transcriptions: ' + error.message, 'error');
                    document.getElementById('completed-list').innerHTML = 
                        '<div class="text-red-400 p-4 text-center">Error loading transcriptions</div>';
                });
        }

        // Show file details
        function showFileDetails() {
            const selectedFilesList = Array.from(selectedFiles);
            if (selectedFilesList.length === 0) {
                showNotification('Please select a file first', 'warning');
                return;
            }
            
            const filePath = selectedFilesList[0]; // Show details for first selected file
            
            fetch(`/api/file-details?path=${encodeURIComponent(filePath)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(details => {
                    if (details.error) {
                        throw new Error(details.error);
                    }
                    
                    const modal = document.getElementById('file-details-modal');
                    const content = document.getElementById('file-details-content');
                    
                    content.innerHTML = `
                        <div class="space-y-2">
                            <p><strong>Name:</strong> ${details.name}</p>
                            <p><strong>Size:</strong> ${formatSize(details.size)}</p>
                            <p><strong>Type:</strong> ${details.type}</p>
                            <p><strong>Created:</strong> ${new Date(details.created_at).toLocaleString()}</p>
                            <p><strong>Modified:</strong> ${new Date(details.modified_at).toLocaleString()}</p>
                            ${details.metadata ? `
                                <div class="mt-4">
                                    <h4 class="font-semibold mb-2">Metadata</h4>
                                    <pre class="bg-gray-700 p-2 rounded text-sm overflow-auto max-h-48">${JSON.stringify(details.metadata, null, 2)}</pre>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    modal.classList.remove('hidden');
                })
                .catch(error => {
                    console.error('Error loading file details:', error);
                    showNotification('Error loading file details: ' + error.message, 'error');
                });
        }

        // Close file details modal
        function closeFileDetails() {
            document.getElementById('file-details-modal').classList.add('hidden');
        }

        // View transcription
        function viewTranscription(id) {
            window.open(`/api/transcriptions/${id}/view`, '_blank');
        }

        // Download transcription
        function downloadTranscription(id) {
            window.location.href = `/api/transcriptions/${id}/download`;
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg z-50 ${
                type === 'error' ? 'bg-red-600' :
                type === 'warning' ? 'bg-yellow-600' :
                type === 'success' ? 'bg-green-600' :
                'bg-blue-600'
            } text-white shadow-lg`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
            
            // Allow manual dismissal
            notification.addEventListener('click', () => notification.remove());
        }

        // Format file size
        function formatSize(size) {
            if (typeof size !== 'number' || isNaN(size) || size === 0) return '';
            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            let s = size;
            let unitIndex = 0;
            while (s >= 1024 && unitIndex < units.length - 1) {
                s /= 1024;
                unitIndex++;
            }
            return `${s.toFixed(1)} ${units[unitIndex]}`;
        }

        // Refresh files
        function refreshFiles() {
            selectedFiles.clear();
            const fileList = document.getElementById('file-list');
            fileList.innerHTML = '<div class="text-gray-400 p-4 text-center">Refreshing...</div>';
            loadFiles();
            showNotification('File list refreshed', 'success');
        }

        // Navigate to directory
        function navigate(path) {
            if (!path || typeof path !== 'string') {
                showNotification('Invalid path', 'error');
                return;
            }
            currentPath = path;
            selectedFiles.clear();
            loadFiles();
        }

        // Navigate up one directory
        function navigateUp() {
            if (!currentPath) {
                currentPath = '';
            } else {
                const parts = currentPath.split('/').filter(Boolean);
                parts.pop();
                currentPath = parts.length ? parts.join('/') : '';
            }
            selectedFiles.clear();
            loadFiles();
        }

        // Start transcription for single file
        function transcribe(path) {
            fetch('/api/transcribe', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ path: path })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.job_id) {
                    showNotification('Transcription job started successfully', 'success');
                    updateQueue();
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('Error starting transcription:', error);
                showNotification('Error starting transcription: ' + error.message, 'error');
            });
        }

        // Update queue display
        function updateQueue() {
            fetch('/api/queue')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(jobs => {
                    if (!Array.isArray(jobs)) {
                        throw new Error('Invalid response format');
                    }
                    
                    const queueList = document.getElementById('queue-list');
                    if (jobs.length === 0) {
                        queueList.innerHTML = '<div class="text-gray-400 p-4 text-center">No jobs in queue</div>';
                        return;
                    }
                    
                    queueList.innerHTML = jobs.map(job => `
                        <div class="bg-gray-700 rounded p-4">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h3 class="font-semibold">${job.video_path ? job.video_path.split('/').pop() : 'Unknown file'}</h3>
                                    <p class="text-sm text-gray-400">${job.status_message || job.status}</p>
                                </div>
                                <div class="flex gap-2">
                                    <span class="px-2 py-1 rounded text-sm ${
                                        job.status === 'completed' ? 'bg-green-600' :
                                        job.status === 'failed' ? 'bg-red-600' :
                                        job.status === 'processing' || job.status === 'started' ? 'bg-blue-600' :
                                        'bg-yellow-600'
                                    }">${job.status}</span>
                                    ${job.status !== 'completed' && job.status !== 'failed' ? `
                                        <button onclick="cancelJob('${job.id}')" 
                                                class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                                            Cancel
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                            ${job.progress !== null && job.progress !== undefined ? `
                                <div class="w-full bg-gray-600 rounded-full h-2 mb-2">
                                    <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: ${job.progress}%"></div>
                                </div>
                                <p class="text-sm text-gray-400">${job.progress.toFixed(1)}% complete</p>
                            ` : ''}
                            ${job.time_remaining ? `
                                <p class="text-sm text-gray-400 mt-2">
                                    Estimated time remaining: ${formatTimeRemaining(job.time_remaining)}
                                </p>
                            ` : ''}
                        </div>
                    `).join('');
                })
                .catch(error => {
                    console.error('Error updating queue:', error);
                    document.getElementById('queue-list').innerHTML = 
                        '<div class="text-red-400 p-4 text-center">Error loading queue</div>';
                });
        }

        // Format time remaining
        function formatTimeRemaining(seconds) {
            if (!seconds || seconds <= 0) return 'Unknown';
            if (seconds > 3600) {
                return `${(seconds / 3600).toFixed(1)} hours`;
            } else if (seconds > 60) {
                return `${Math.round(seconds / 60)} minutes`;
            } else {
                return `${Math.round(seconds)} seconds`;
            }
        }

        // Queue selected files for transcription
        function queueSelectedFiles() {
            const paths = Array.from(selectedFiles);
            if (paths.length === 0) {
                showNotification('Please select at least one video file.', 'warning');
                return;
            }
            
            fetch('/api/transcribe/batch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ paths: paths })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                let message = '';
                if (data.queued && data.queued.length > 0) {
                    message += `Successfully queued ${data.queued.length} file(s) for transcription.`;
                    updateQueue();
                    
                    // Clear selections after successful queueing
                    selectedFiles.clear();
                    document.querySelectorAll('.file-checkbox:checked').forEach(cb => cb.checked = false);
                    handleFileSelection('', false); // Update button state
                }
                if (data.errors && data.errors.length > 0) {
                    if (message) message += ' ';
                    message += `However, ${data.errors.length} file(s) could not be queued.`;
                    console.error('Queueing errors:', data.errors);
                }
                showNotification(message, data.errors && data.errors.length > 0 ? 'warning' : 'success');
            })
            .catch(error => {
                console.error('Error queueing files:', error);
                showNotification('Error queueing files: ' + error.message, 'error');
            });
        }

        // Cancel job
        function cancelJob(jobId) {
            if (!confirm('Are you sure you want to cancel this job?')) {
                return;
            }
            
            fetch(`/api/queue/stop/${jobId}`, {
                method: 'POST'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    showNotification('Job cancelled successfully', 'success');
                    updateQueue();
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('Error cancelling job:', error);
                showNotification('Error cancelling job: ' + error.message, 'error');
            });
        }

        // Remove failed transcription
        function removeTranscription(transcriptionId) {
            if (!confirm('Are you sure you want to remove this transcription?')) {
                return;
            }
            
            fetch(`/api/transcriptions/${transcriptionId}/remove`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.message) {
                    showNotification(data.message, 'success');
                    loadCompletedTranscriptions();
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('Error removing transcription:', error);
                showNotification('Error removing transcription: ' + error.message, 'error');
            });
        }
    </script>
</body>
</html> 